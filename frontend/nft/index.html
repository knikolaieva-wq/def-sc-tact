<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DefNFT ‚Äî Pinata ‚Üí Mint (TON)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <script src="/config.js"></script>

  <script type="module">
    import { beginCell, Address } from 'https://esm.sh/@ton/core@0.62.0';
    import { TonClient, Address as TonAddress } from 'https://esm.sh/@ton/ton@15.4.0';
    import { getHttpEndpoint } from 'https://esm.sh/@orbs-network/ton-access@2.3.3';
    import { Buffer } from 'https://esm.sh/buffer@6.0.3';

    window.Buffer = Buffer;
    window.TonCore = { beginCell, Address };
    window.TonRpc = { TonClient, TonAddress, getHttpEndpoint };
    window.tonLibsReady = true;
  </script>

  <style>
    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    pre {
      white-space: pre-wrap;
      word-break: break-word;
    }

    #ton-connect {
      display: none !important;
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-b from-gray-50 to-white text-gray-900">
  <div class="max-w-6xl mx-auto p-6 space-y-8">
    <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div>
        <h1 class="text-3xl font-bold">DefNFT (TON)</h1>
        <p class="text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚Üí Pinata ‚Üí –ú–µ—Ç–∞–¥–∞—Ç–∞ ‚Üí –ú–∏–Ω—Ç/–∞–¥–º–∏–Ω –¥–µ–π—Å—Ç–≤–∏–π</p>
        <p id="netInfo" class="text-gray-600 text-sm mt-1">–°–µ—Ç—å: ‚Äî</p>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        <select id="tonNetwork"
          class="px-3 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-black/50">
          <option value="testnet" selected>TON Testnet</option>
          <option value="mainnet">TON Mainnet</option>
        </select>
        <button id="connectBtn"
          class="inline-flex items-center justify-center rounded-xl bg-black text-white px-4 py-2 font-medium shadow-sm hover:bg-gray-900 focus:outline-none focus:ring-2 focus:ring-black/50 disabled:opacity-60 disabled:cursor-not-allowed">–ü–æ–¥–∫–ª—é—á–∏—Ç—å
          Tonkeeper</button>
        <button id="connectDirectBtn"
          class="inline-flex items-center justify-center rounded-xl border border-gray-900 text-gray-900 px-4 py-2 font-medium hover:bg-gray-900 hover:text-white focus:outline-none focus:ring-2 focus:ring-black/50">–û—Ç–∫—Ä—ã—Ç—å
          Tonkeeper</button>
        <div id="wallet-info" class="text-sm text-gray-700"></div>
      </div>
      <div id="ton-connect"></div>
    </header>

    <section class="rounded-2xl border border-dashed border-gray-300 bg-gray-50 p-4 text-sm text-gray-700">
      –ö–ª–∏–µ–Ω—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è DefNFT: mint, burn, whitelist, tx processors –∏ get-–º–µ—Ç–æ–¥—ã. –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
      –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ Pinata (JWT —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤). –ï—Å–ª–∏ –≤—ã —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç–µ –ø–æ–¥ –¥—Ä—É–≥—É—é
      —Å–µ—Ç—å, –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ —Å–µ–ª–µ–∫—Ç–æ—Ä –≤ —Ö–µ–¥–µ—Ä–µ.
    </section>

    <section class="rounded-2xl border bg-white p-4 space-y-2">
      <label class="flex flex-col gap-1">
        <span class="text-sm font-medium">Pinata JWT (–¥–ª—è —Ç–µ—Å—Ç–æ–≤; –≤ –ø—Ä–æ–¥–∞–∫—à–Ω–µ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ)</span>
        <input id="pinataJwt" type="password"
          class="px-3 py-2 rounded-xl border focus:ring-2 focus:ring-black/10"
          placeholder="eyJhbGciOi..." value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySW5mb3JtYXRpb24iOnsiaWQiOiI1ZDNhZTBjNC03OWI1LTRkMjMtOThiYS1lZTlkNDg4ODY5NDIiLCJlbWFpbCI6InMuYm9yaXNvdkBhZHYyLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJwaW5fcG9saWN5Ijp7InJlZ2lvbnMiOlt7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6IkZSQTEifSx7ImRlc2lyZWRSZXBsaWNhdGlvbkNvdW50IjoxLCJpZCI6Ik5ZQzEifV0sInZlcnNpb24iOjF9LCJtZmFfZW5hYmxlZCI6ZmFsc2UsInN0YXR1cyI6IkFDVElWRSJ9LCJhdXRoZW50aWNhdGlvblR5cGUiOiJzY29wZWRLZXkiLCJzY29wZWRLZXlLZXkiOiI1NGI1MjViMzJjYjE4NTdiOTNlNiIsInNjb3BlZEtleVNlY3JldCI6ImIwYzQ1OGVkNzI1ZTcwMzA4YjE4NzMwMmJjNTBlNzgwYWI1MjNlYmRkZmYzNGI1MjFmODkwZjY0MDg3OTBhNjkiLCJleHAiOjE3OTAyMzY0MTh9.gHgWwNWzUKBgMoWipKkStlraLXhgB6lSntiFaR_VViM"
        />
      </label>
      <p class="text-xs text-gray-500">JWT –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤—ã–∑–æ–≤–æ–≤ pinFileToIPFS –∏ pinJSONToIPFS –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞.</p>
    </section>

    <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="p-4 rounded-2xl border bg-white flex items-center gap-3">
        <div id="dot1" class="h-8 w-8 rounded-full bg-black text-white grid place-items-center">1</div>
        <div class="text-sm font-medium">–ö–∞—Ä—Ç–∏–Ω–∫–∞</div>
      </div>
      <div class="p-4 rounded-2xl border bg-white flex items-center gap-3">
        <div id="dot2" class="h-8 w-8 rounded-full bg-white text-gray-600 border grid place-items-center">2</div>
        <div class="text-sm font-medium">–ú–µ—Ç–∞–¥–∞—Ç–∞</div>
      </div>
      <div class="p-4 rounded-2xl border bg-white flex items-center gap-3">
        <div id="dot3" class="h-8 w-8 rounded-full bg-white text-gray-600 border grid place-items-center">3</div>
        <div class="text-sm font-medium">–ö–æ–Ω—Ç—Ä–∞–∫—Ç</div>
      </div>
      <div class="p-4 rounded-2xl border bg-white flex items-center gap-3">
        <div id="dot4" class="h-8 w-8 rounded-full bg-white text-gray-600 border grid place-items-center">4</div>
        <div class="text-sm font-medium">–ì–æ—Ç–æ–≤–æ</div>
      </div>
    </section>

    <main class="rounded-3xl border bg-white shadow-sm p-6 md:p-8 space-y-10">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div>
          <h2 class="font-semibold mb-3">1) –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h2>
          <div id="dropZone"
            class="rounded-2xl border-2 border-dashed p-6 text-center transition border-gray-300">
            <div id="imageEmpty">
              <div class="text-4xl mb-2">üñºÔ∏è</div>
              <div class="text-sm text-gray-700 mb-2">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ</div>
              <label class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border cursor-pointer hover:bg-gray-50">
                <input id="imageInput" type="file" accept="image/*" class="hidden" />
                –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
              </label>
              <div id="imageError" class="text-xs text-red-500 mt-2 hidden"></div>
            </div>
            <div id="imagePreviewWrap" class="hidden space-y-3">
              <img id="imagePreview" class="mx-auto max-h-56 rounded-xl border object-contain" />
              <div id="imageInfo" class="text-xs text-gray-600"></div>
              <button id="replaceBtn" class="px-4 py-2 rounded-xl bg-black text-white">–ó–∞–º–µ–Ω–∏—Ç—å</button>
            </div>
          </div>

          <div id="imageCidBox" class="hidden mt-4 p-3 rounded-xl border bg-gray-50 text-sm">
            <div class="font-medium">IPFS (image):</div>
            <div id="imageCid" class="break-all"></div>
            <a id="imageGateway" class="underline text-blue-600" target="_blank" rel="noreferrer">–û—Ç–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ —à–ª—é–∑</a>
          </div>
        </div>

        <div>
          <h2 class="font-semibold mb-3">2) –ú–µ—Ç–∞–¥–∞—Ç–∞</h2>
          <div class="grid gap-4">
            <label class="flex flex-col gap-1">
              <span class="text-sm font-medium">–ù–∞–∑–≤–∞–Ω–∏–µ</span>
              <input id="name" class="px-3 py-2 rounded-xl border focus:ring-2 focus:ring-black/10" value="Partner NFT" />
              <span id="nameErr" class="text-xs text-red-500 hidden"></span>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm font-medium">–û–ø–∏—Å–∞–Ω–∏–µ</span>
              <input id="description" class="px-3 py-2 rounded-xl border focus:ring-2 focus:ring-black/10"
                value="Soulbound partner NFT with revenue share." />
              <span id="descErr" class="text-xs text-red-500 hidden"></span>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm font-medium">Partner name</span>
              <input id="partnerName" class="px-3 py-2 rounded-xl border focus:ring-2 focus:ring-black/10" placeholder="Partner Name" />
              <span id="partnerErr" class="text-xs text-red-500 hidden"></span>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm font-medium">Reward, % (0‚Äì100)</span>
              <input id="rewardPercent" type="number" min="0" max="100" value="10"
                class="px-3 py-2 rounded-xl border focus:ring-2 focus:ring-black/10" />
              <span id="pctErr" class="text-xs text-red-500 hidden"></span>
            </label>
            <label class="flex flex-col gap-1">
              <span class="text-sm font-medium">Grade</span>
              <select id="grade" class="px-3 py-2 rounded-xl border focus:ring-2 focus:ring-black/10">
                <option value="Bronze" selected>Bronze</option>
                <option value="Silver">Silver</option>
                <option value="Gold">Gold</option>
                <option value="Platinum">Platinum</option>
              </select>
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input id="httpImage" type="checkbox" class="rounded border" />
              <span>–í –º–µ—Ç–∞–¥–∞—Ç–µ —Å—Ç–∞–≤–∏—Ç—å HTTP-—Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É</span>
            </label>
          </div>

          <div id="metaCidBox" class="hidden mt-4 p-3 rounded-xl border bg-gray-50 text-sm">
            <div class="font-medium">IPFS (metadata):</div>
            <div id="metaCid" class="break-all"></div>
            <a id="metaGateway" class="underline text-blue-600" target="_blank" rel="noreferrer">–û—Ç–∫—Ä—ã—Ç—å JSON</a>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-between">
        <div class="text-sm text-gray-600">–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç–∞–¥–∞—Ç—ã –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å mint.</div>
        <div class="flex gap-3">
          <button id="toMetaBtn" class="px-4 py-2 rounded-xl border hover:bg-gray-50">–î–∞–ª–µ–µ</button>
          <button id="uploadBtn" class="px-4 py-2 rounded-xl bg-black text-white hidden">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤ Pinata</button>
        </div>
      </div>

      <section class="space-y-6">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">3) –ö–æ–Ω—Ç—Ä–∞–∫—Ç DefNFT</h2>
          <span class="inline-block text-xs px-2 py-0.5 rounded-full bg-black text-white">Owner-only</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <label class="flex flex-col gap-1">
            <span class="text-sm font-medium">–ê–¥—Ä–µ—Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</span>
            <input id="contractAddress" class="px-3 py-2 rounded-xl border focus:ring-2 focus:ring-black/10" placeholder="EQ..." />
            <span id="contractErr" class="text-xs text-red-500 hidden"></span>
          </label>
          <label class="flex flex-col gap-1">
            <span class="text-sm font-medium">–ú–∏–Ω—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª—é (to)</span>
            <input id="mintTo" class="px-3 py-2 rounded-xl border focus:ring-2 focus:ring-black/10" placeholder="EQ..." />
            <span id="mintToErr" class="text-xs text-red-500 hidden"></span>
          </label>
          <label class="flex flex-col gap-1">
            <span class="text-sm font-medium">Reward, % (0‚Äì100)</span>
            <input id="mintReward" type="number" min="0" max="100" value="10"
              class="px-3 py-2 rounded-xl border focus:ring-2 focus:ring-black/10" />
          </label>
          <label class="flex flex-col gap-1">
            <span class="text-sm font-medium">URI (–∏–∑ Pinata –∏–ª–∏ –≤—Ä—É—á–Ω—É—é)</span>
            <input id="mintUri" class="px-3 py-2 rounded-xl border focus:ring-2 focus:ring-black/10" placeholder="ipfs://..." />
          </label>
        </div>

        <div class="flex items-center justify-between">
          <div class="text-sm text-gray-600">–ú–∏–Ω—Ç —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∞–≤ owner –∏ ~0.05 TON –Ω–∞ –≥–∞–∑/—Ö—Ä–∞–Ω–µ–Ω–∏–µ.</div>
          <button id="mintBtn" class="px-4 py-2 rounded-xl bg-black text-white disabled:opacity-50" disabled>–ú–∏–Ω—Ç</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <label class="flex flex-col gap-1">
            <span class="text-sm font-medium">TokenId –¥–ª—è —Å–∂–∏–≥–∞–Ω–∏—è</span>
            <input id="burnTokenId" class="px-3 py-2 rounded-xl border focus:ring-2 focus:ring-black/10" placeholder="1" />
          </label>
          <button id="burnBtn"
            class="self-end px-4 py-2 rounded-xl border border-gray-900 text-gray-900 hover:bg-gray-900 hover:text-white disabled:opacity-50">Burn</button>

          <label class="flex flex-col gap-1">
            <span class="text-sm font-medium">Whitelist –∞–¥—Ä–µ—Å</span>
            <input id="whitelistAddr" class="px-3 py-2 rounded-xl border focus:ring-2 focus:ring-black/10" placeholder="EQ..." />
          </label>
          <div class="flex items-center gap-3 self-end">
            <button id="addWhitelistBtn" class="px-4 py-2 rounded-xl border hover:bg-gray-50">–î–æ–±–∞–≤–∏—Ç—å</button>
            <button id="removeWhitelistBtn" class="px-4 py-2 rounded-xl border hover:bg-gray-50">–£–¥–∞–ª–∏—Ç—å</button>
          </div>

          <label class="flex flex-col gap-1">
            <span class="text-sm font-medium">Tx processor –∞–¥—Ä–µ—Å</span>
            <input id="processorAddr" class="px-3 py-2 rounded-xl border focus:ring-2 focus:ring-black/10" placeholder="EQ..." />
          </label>
          <div class="flex items-center gap-3 self-end">
            <label class="flex items-center gap-2 text-sm">
              <input id="processorAllowed" type="checkbox" class="rounded border" /> allowed
            </label>
            <button id="setProcessorBtn" class="px-4 py-2 rounded-xl border hover:bg-gray-50">Set processor</button>
          </div>

          <label class="flex flex-col gap-1">
            <span class="text-sm font-medium">Increment –¥–ª—è –∫–æ—à–µ–ª—å–∫–∞</span>
            <input id="incrementWallet" class="px-3 py-2 rounded-xl border focus:ring-2 focus:ring-black/10" placeholder="EQ..." />
          </label>
          <button id="incrementBtn"
            class="self-end px-4 py-2 rounded-xl border border-gray-900 text-gray-900 hover:bg-gray-900 hover:text-white disabled:opacity-50">IncrementSuccessfulTx</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="p-4 rounded-2xl border border-gray-200 bg-gray-50 space-y-3">
            <div class="flex items-center justify-between">
              <div class="font-semibold">TEP-62 collection data</div>
              <button id="readCollectionBtn"
                class="px-3 py-1.5 rounded-xl border border-gray-900 text-gray-900 hover:bg-gray-900 hover:text-white text-sm">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            <pre id="collectionDataOut" class="text-sm text-gray-700 whitespace-pre-wrap break-all">‚Äî</pre>
          </div>
          <div class="p-4 rounded-2xl border border-gray-200 bg-gray-50 space-y-3">
            <label class="flex flex-col gap-1">
              <span class="text-sm font-medium">–ò–Ω–¥–µ–∫—Å NFT</span>
              <input id="nftIndexLookup" class="px-3 py-2 rounded-xl border focus:ring-2 focus:ring-black/10" placeholder="0" />
            </label>
            <div class="flex flex-wrap gap-3">
              <button id="nftIndexBtn"
                class="px-4 py-2 rounded-xl border border-gray-900 text-gray-900 hover:bg-gray-900 hover:text-white">–ê–¥—Ä–µ—Å NFT</button>
              <button id="nftDataBtn"
                class="px-4 py-2 rounded-xl border border-gray-900 text-gray-900 hover:bg-gray-900 hover:text-white">get_nft_data</button>
            </div>
            <div>
              <div class="text-xs uppercase tracking-wide text-gray-500">NFT address</div>
              <div id="nftAddressOut" class="text-sm break-all text-gray-800">‚Äî</div>
            </div>
            <div>
              <div class="text-xs uppercase tracking-wide text-gray-500">NFT data</div>
              <pre id="nftDataOut" class="text-xs bg-white rounded-xl border border-gray-200 p-3 break-all">‚Äî</pre>
            </div>
          </div>
        </div>
      </section>

      <section class="space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">4) Get-–º–µ—Ç–æ–¥—ã</h2>
          <button id="readWalletBtn"
            class="px-4 py-2 rounded-xl border border-gray-900 text-gray-900 hover:bg-gray-900 hover:text-white">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å
            –∫–æ—à–µ–ª—ë–∫</button>
        </div>

        <label class="flex flex-col gap-1">
          <span class="text-sm font-medium">–ê–¥—Ä–µ—Å –∫–æ—à–µ–ª—å–∫–∞</span>
          <input id="walletLookup" class="px-3 py-2 rounded-xl border focus:ring-2 focus:ring-black/10" placeholder="EQ..." />
        </label>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="p-4 rounded-2xl border bg-gray-50">
            <div class="font-semibold mb-1">tokenOf(wallet)</div>
            <div id="tokenOfOut" class="text-sm">‚Äî</div>
          </div>
          <div class="p-4 rounded-2xl border bg-gray-50">
            <div class="font-semibold mb-1">platformShareBpsForWallet(wallet)</div>
            <div id="shareOut" class="text-sm">‚Äî</div>
          </div>
          <div class="p-4 rounded-2xl border bg-gray-50">
            <div class="font-semibold mb-1">isWalletWhitelisted(wallet)</div>
            <div id="whitelistOut" class="text-sm">‚Äî</div>
          </div>
          <div class="p-4 rounded-2xl border bg-gray-50">
            <div class="font-semibold mb-1">successfulTxCountOf(wallet)</div>
            <div id="successOut" class="text-sm">‚Äî</div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="flex flex-col gap-1">
            <span class="text-sm font-medium">ownerOf(tokenId)</span>
            <input id="ownerOfTokenId" class="px-3 py-2 rounded-xl border focus:ring-2 focus:ring-black/10" placeholder="1" />
          </label>
          <div class="flex items-end">
            <button id="ownerOfBtn"
              class="px-4 py-2 rounded-xl border border-gray-900 text-gray-900 hover:bg-gray-900 hover:text-white">–ß–∏—Ç–∞—Ç—å
              ownerOf</button>
          </div>
        </div>
        <div class="p-4 rounded-2xl border bg-gray-50">
          <div class="font-semibold mb-1">ownerOf(tokenId)</div>
          <div id="ownerOfOut" class="text-sm">‚Äî</div>
        </div>
      </section>
    </main>

    <section class="grid md:grid-cols-3 gap-6" id="results">
      <div class="p-4 rounded-2xl border bg-white">
        <div class="font-semibold mb-1">Image CID</div>
        <div id="resImage" class="text-sm break-all text-gray-700">‚Äî</div>
      </div>
      <div class="p-4 rounded-2xl border bg-white">
        <div class="font-semibold mb-1">Metadata CID</div>
        <div id="resMeta" class="text-sm break-all text-gray-700">‚Äî</div>
      </div>
      <div class="p-4 rounded-2xl border bg-white">
        <div class="font-semibold mb-1">–ü–æ—Å–ª–µ–¥–Ω–∏–π NFT (index / address)</div>
        <div class="text-xs text-gray-500">Index</div>
        <div id="resToken" class="text-sm text-gray-700">‚Äî</div>
        <div class="text-xs text-gray-500 mt-3">Item address</div>
        <div id="resTokenAddress" class="text-sm text-gray-700 break-all">‚Äî</div>
      </div>
    </section>

    <div class="flex justify-between items-center">
      <button id="resetBtn" class="px-4 py-2 rounded-xl border hover:bg-gray-50">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ä–º—É</button>
      <div id="status" class="text-sm text-gray-700"></div>
    </div>

    <footer class="text-xs text-gray-500">
      <p>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ Tonkeeper —á–µ—Ä–µ–∑ TonConnect. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø—Ä–∞–≤–∞ owner –ø–µ—Ä–µ–¥
        –æ—Ç–ø—Ä–∞–≤–∫–æ–π.</p>
      <p>–õ–æ–≥–∏ –∏ –æ—à–∏–±–∫–∏ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞.</p>
    </footer>
  </div>

  <script>
    const RPC_TESTNET = 'https://testnet.toncenter.com/api/v2/jsonRPC?api_key=d6435d6f150fa5b1666037ec9998f6e951ca11845b11f25939c49174d6221027';
    const OPS = {
      mint: 0x157c62bb,
      burn: 0xca9e378a,
      increment: 0xb803b08d,
      setProcessor: 0x791c083b,
      addWhitelist: 0x2231a99d,
      removeWhitelist: 0x871d66eb,
    };
    const toNano = (ton) => {
      const value = Number(ton || 0);
      if (Number.isNaN(value)) return 0n;
      return BigInt(Math.round(value * 1e9));
    };

    const manifestUrlResolved = new URL('/tonconnect-manifest.json', window.location.origin).toString();
    const manifestUrlOverride = window.__TONCONNECT_MANIFEST_URL;
    const manifestUrlFinal = manifestUrlOverride || manifestUrlResolved;
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({ manifestUrl: manifestUrlFinal });

    let step = 1;
    let imageFile = null;
    let imageCid = '';
    let metaCid = '';

    const $ = (id) => document.getElementById(id);
    const setDot = (n, state) => {
      const el = $('dot' + n);
      if (!el) return;
      el.className = 'h-8 w-8 rounded-full grid place-items-center border';
      if (state === 'active') el.classList.add('bg-black', 'text-white', 'border-black');
      else if (state === 'done') el.classList.add('bg-emerald-600', 'text-white', 'border-emerald-600');
      else el.classList.add('bg-white', 'text-gray-600', 'border-gray-300');
      el.textContent = state === 'done' ? '‚úì' : n;
    };
    const showStatus = (msg) => $('status').textContent = msg || '';

    const decodeCommentCell = (cell) => {
      if (!cell) return '';
      try {
        const slice = cell.beginParse();
        if (slice.remainingBits >= 8) {
          const prefix = slice.loadUint(8);
          if (prefix === 0) {
            if (slice.remainingBits >= 24) slice.loadUint(24);
            return slice.loadStringTail();
          }
          if (prefix === 0x01) {
            return slice.loadStringTail();
          }
        }
      } catch (err) {
        console.warn('decode content error', err);
      }
      try {
        return Buffer.from(cell.toBoc()).toString('hex');
      } catch {
        return '';
      }
    };

    const cellToAddressString = (cell) => {
      try {
        const parsed = cell.beginParse().loadAddress();
        return parsed ? parsed.toString({ bounceable: false }) : '';
      } catch {
        return '';
      }
    };

    const stackInt = (value) => ({ type: 'int', value: BigInt(value) });

    function updateStepUI() {
      setDot(1, step > 1 ? 'done' : 'active');
      setDot(2, step === 2 ? 'active' : step > 2 ? 'done' : 'default');
      setDot(3, step === 3 ? 'active' : step > 3 ? 'done' : 'default');
      setDot(4, step >= 4 ? 'done' : 'default');

      $('uploadBtn').classList.toggle('hidden', step < 2);
      $('toMetaBtn').classList.toggle('hidden', step >= 2);

      const hasUri = Boolean(metaCid || $('mintUri').value.trim());
      $('mintBtn').disabled = !hasUri || !tonConnectUI.wallet;
    }

    const STORAGE_KEY = 'defnft_form_data_v1';
    const TEXT_FIELDS = [
      'pinataJwt',
      'name',
      'description',
      'partnerName',
      'rewardPercent',
      'grade',
      'contractAddress',
      'mintTo',
      'mintReward',
      'mintUri',
      'burnTokenId',
      'whitelistAddr',
      'processorAddr',
      'incrementWallet',
      'walletLookup',
      'ownerOfTokenId',
      'nftIndexLookup'
    ];
    const CHECKBOX_FIELDS = ['httpImage', 'processorAllowed'];

    function saveFormData() {
      try {
        const data = {};
        TEXT_FIELDS.forEach((id) => {
          const el = $(id);
          if (el) data[id] = el.value;
        });
        CHECKBOX_FIELDS.forEach((id) => {
          const el = $(id);
          if (el) data[id] = el.checked;
        });
        const networkEl = $('tonNetwork');
        if (networkEl) data.tonNetwork = networkEl.value;
        data.metaCid = metaCid;
        data.imageCid = imageCid;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (err) {
        console.warn('saveFormData error', err);
      }
    }

    function loadFormData() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return;
        const data = JSON.parse(saved);
        TEXT_FIELDS.forEach((id) => {
          if (Object.prototype.hasOwnProperty.call(data, id)) {
            const el = $(id);
            if (el && typeof data[id] === 'string') el.value = data[id];
          }
        });
        CHECKBOX_FIELDS.forEach((id) => {
          if (Object.prototype.hasOwnProperty.call(data, id)) {
            const el = $(id);
            if (el) el.checked = !!data[id];
          }
        });
        if (typeof data.tonNetwork === 'string') {
          $('tonNetwork').value = data.tonNetwork;
          $('netInfo').textContent = `–°–µ—Ç—å: ${data.tonNetwork === 'testnet' ? 'TON Testnet' : 'TON Mainnet'}`;
        }
        if (typeof data.imageCid === 'string') {
          imageCid = data.imageCid;
          if (imageCid) {
            $('imageCidBox').classList.remove('hidden');
            $('imageCid').textContent = (imageCid.startsWith('ipfs://') ? imageCid : `ipfs://${imageCid}`);
            $('imageGateway').href = `https://ipfs.io/ipfs/${imageCid.replace('ipfs://', '')}`;
            $('resImage').textContent = imageCid.replace('ipfs://', '');
          }
        }
        if (typeof data.metaCid === 'string') {
          metaCid = data.metaCid;
          if (metaCid) {
            $('metaCidBox').classList.remove('hidden');
            $('metaCid').textContent = metaCid.startsWith('ipfs://') ? metaCid : `ipfs://${metaCid}`;
            $('metaGateway').href = `https://ipfs.io/ipfs/${metaCid.replace('ipfs://', '')}`;
            $('resMeta').textContent = metaCid.replace('ipfs://', '');
            if (!$('mintUri').value) {
              $('mintUri').value = metaCid.startsWith('ipfs://') ? metaCid : `ipfs://${metaCid}`;
            }
            if (step < 3) step = 3;
          }
        }
        if (imageCid || metaCid) {
          $('results').classList.remove('hidden');
        }
      } catch (err) {
        console.error('loadFormData error', err);
      }
      updateStepUI();
    }

    function attachAutoSave() {
      const inputs = [...TEXT_FIELDS, 'tonNetwork'];
      inputs.forEach((id) => {
        const el = $(id);
        if (!el) return;
        el.addEventListener('input', saveFormData);
        el.addEventListener('change', saveFormData);
      });
      CHECKBOX_FIELDS.forEach((id) => {
        const el = $(id);
        if (!el) return;
        el.addEventListener('change', saveFormData);
      });
    }

    function clearFormData() {
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch {}
    }

    loadFormData();
    attachAutoSave();

    function waitForLibs() {
      return new Promise((resolve) => {
        const check = () => {
          if (window.tonLibsReady && window.TonCore && window.TonRpc) resolve();
          else setTimeout(check, 100);
        };
        check();
      });
    }

    function formatTonAddress(address) {
      try {
        if (!address) return '';
        if (address.includes(':')) {
          return window.TonCore.Address.parse(address).toString({ bounceable: false });
        }
        return address;
      } catch {
        return address;
      }
    }

    function updateWalletUI(wallet) {
      if (wallet) {
        const friendly = formatTonAddress(wallet.account.address);
        $('wallet-info').textContent = `${friendly.slice(0, 6)}‚Ä¶${friendly.slice(-4)}`;
        $('connectBtn').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
        const hasUri = Boolean(metaCid || $('mintUri').value.trim());
        $('mintBtn').disabled = !hasUri;
      } else {
        $('wallet-info').textContent = '';
        $('connectBtn').textContent = '–ü–æ–¥–∫–ª—é—á–∏—Ç—å Tonkeeper';
        $('mintBtn').disabled = true;
      }
    }

    async function rpcClientForCurrentNet() {
      const { TonClient, getHttpEndpoint } = window.TonRpc;
      const isTestnet = $('tonNetwork').value === 'testnet';
      if (isTestnet) return new TonClient({ endpoint: RPC_TESTNET });
      const endpoint = await getHttpEndpoint({ network: 'mainnet' });
      return new TonClient({ endpoint });
    }

    function buildOp(op, builderFn) {
      const { beginCell } = window.TonCore;
      const cell = beginCell();
      cell.storeUint(op, 32);
      //cell.storeUint(0, 64);
      builderFn?.(cell);
      return cell.endCell();
    }

    function stackAddress(addr) {
      const { beginCell, Address } = window.TonCore;
      const cell = beginCell();
      cell.storeAddress(Address.parse(addr));
      return { type: 'slice', cell: cell.endCell() };
    }

    async function sendMessage(contractAddr, bodyCell, amount) {
      const wallet = tonConnectUI.wallet;
      if (!wallet) throw new Error('–ü–æ–¥–∫–ª—é—á–∏—Ç–µ Tonkeeper');
      const payload = Buffer.from(bodyCell.toBoc()).toString('base64');
      const tx = {
        validUntil: Math.floor(Date.now() / 1000) + 300,
        messages: [{
          address: contractAddr,
          amount: amount.toString(),
          payload,
        }],
      };
      await tonConnectUI.sendTransaction(tx);
    }

    function validateAddress(value, errEl) {
      errEl.classList.add('hidden');
      if (!value) {
        errEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å';
        errEl.classList.remove('hidden');
        throw new Error('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å');
      }
      try {
        window.TonCore.Address.parse(value);
      } catch (e) {
        errEl.textContent = '–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π TON –∞–¥—Ä–µ—Å';
        errEl.classList.remove('hidden');
        throw e;
      }
    }

    function validateTokenId(value) {
      const n = BigInt(value || '0');
      if (n < 0n) throw new Error('tokenId > 0');
      return n;
    }

    function calcShareBps(percent) {
      const p = Number(percent);
      if (!Number.isFinite(p) || p < 0 || p > 100) throw new Error('Reward % –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0‚Äì100');
      return Math.round(p * 100);
    }

    async function readCollectionData() {
      const addr = $('contractAddress').value.trim();
      if (!addr) throw new Error('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞');
      const client = await rpcClientForCurrentNet();
      const res = await client.runMethod(window.TonRpc.TonAddress.parse(addr), 'get_collection_data', []);
      const nextIndex = res.stack.readNumber();
      const contentCell = res.stack.readCell();
      const ownerAddr = res.stack.readAddress();
      const ownerStr = ownerAddr.toString({ bounceable: false });
      const contentText = decodeCommentCell(contentCell);
      collectionDataOut.textContent = `nextIndex: ${nextIndex}\nowner: ${ownerStr}\ncontent: ${contentText}`;
    }

    async function fetchNftAddressByIndex(contractAddr, index) {
      const client = await rpcClientForCurrentNet();
      const idx = BigInt(index);
      const res = await client.runMethod(
        window.TonRpc.TonAddress.parse(contractAddr),
        'get_nft_address_by_index',
        [stackInt(idx)]
      );
      const addr = res.stack.readAddress();
      return addr.toString({ bounceable: false });
    }

    async function readNftAddressOnly() {
      const contractAddr = $('contractAddress').value.trim();
      if (!contractAddr) throw new Error('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞');
      const raw = (nftIndexLookupEl.value || '').trim();
      if (raw === '') throw new Error('–í–≤–µ–¥–∏—Ç–µ –∏–Ω–¥–µ–∫—Å');
      const index = Number(raw);
      if (!Number.isFinite(index) || index < 0) throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å');
      const nftAddr = await fetchNftAddressByIndex(contractAddr, index);
      nftAddressOut.textContent = nftAddr;
      $('resToken').textContent = String(index);
      resTokenAddressEl.textContent = nftAddr;
      return { index, nftAddr };
    }

    async function readNftDataByIndex() {
      const { index, nftAddr } = await readNftAddressOnly();
      const client = await rpcClientForCurrentNet();
      const res = await client.runMethod(window.TonRpc.TonAddress.parse(nftAddr), 'get_nft_data', []);
      const initFlag = res.stack.readNumber();
      const idx = res.stack.readNumber();
      const collectionCell = res.stack.readCell();
      const ownerCell = res.stack.readCell();
      const contentCell = res.stack.readCell();
      const collectionAddr = cellToAddressString(collectionCell);
      const ownerAddr = cellToAddressString(ownerCell);
      const contentText = decodeCommentCell(contentCell);
      nftDataOut.textContent = JSON.stringify(
        { init: initFlag, index: idx, collection: collectionAddr, owner: ownerAddr, content: contentText },
        null,
        2
      );
      return { index, nftAddr };
    }

    async function getTokenIndex(contractAddr, walletAddr) {
      const client = await rpcClientForCurrentNet();
      const res = await client.runMethod(
        window.TonRpc.TonAddress.parse(contractAddr),
        'tokenOf',
        [stackAddress(walletAddr)]
      );
      return res.stack.readNumber();
    }

    function resetMetadataUI() {
      $('imageEmpty').classList.remove('hidden');
      $('imagePreviewWrap').classList.add('hidden');
      $('imageCidBox').classList.add('hidden');
      $('metaCidBox').classList.add('hidden');
      $('imageInput').value = '';
      $('partnerName').value = '';
      $('rewardPercent').value = '10';
      $('resImage').textContent = '‚Äî';
      $('resMeta').textContent = '‚Äî';
      $('resToken').textContent = '‚Äî';
      imageFile = null;
      imageCid = '';
      metaCid = '';
      $('mintUri').value = '';
      $('uploadBtn').classList.add('hidden');
      $('toMetaBtn').classList.remove('hidden');
      step = 1;
      updateStepUI();
    }

    waitForLibs().then(() => {
      updateStepUI();
      $('netInfo').textContent = '–°–µ—Ç—å: TON Testnet';

      tonConnectUI.onStatusChange(updateWalletUI);
      setTimeout(() => updateWalletUI(tonConnectUI.wallet), 100);

      $('connectBtn').addEventListener('click', async () => {
        try {
          await tonConnectUI.openModal();
        } catch (e) {
          console.error(e);
          alert(e?.message || e);
        }
      });

      $('connectDirectBtn').addEventListener('click', () => {
        const manifestUrl = encodeURIComponent(manifestUrlFinal);
        const isTestnet = $('tonNetwork').value === 'testnet';
        const testnetParam = isTestnet ? '&testnet=true' : '';
        window.open(`https://app.tonkeeper.com/ton-connect?manifest_url=${manifestUrl}${testnetParam}`, '_blank');
      });

      $('tonNetwork').addEventListener('change', (e) => {
        $('netInfo').textContent = `–°–µ—Ç—å: ${e.target.value === 'testnet' ? 'TON Testnet' : 'TON Mainnet'}`;
        saveFormData();
      });

      const collectionDataOut = $('collectionDataOut');
      const nftIndexLookupEl = $('nftIndexLookup');
      const nftAddressOut = $('nftAddressOut');
      const nftDataOut = $('nftDataOut');
      const resTokenAddressEl = $('resTokenAddress');
      const dropZone = $('dropZone');
      const readCollectionBtn = $('readCollectionBtn');
      const nftIndexBtn = $('nftIndexBtn');
      const nftDataBtn = $('nftDataBtn');

      readCollectionBtn?.addEventListener('click', () => {
        readCollectionData().catch((e) => showStatus('get_collection_data error: ' + (e?.message || e)));
      });

      nftIndexBtn?.addEventListener('click', () => {
        readNftAddressOnly().catch((e) => showStatus('get_nft_address error: ' + (e?.message || e)));
      });

      nftDataBtn?.addEventListener('click', () => {
        readNftDataByIndex().catch((e) => showStatus('get_nft_data error: ' + (e?.message || e)));
      });

      $('mintUri').addEventListener('input', () => {
        const hasValue = Boolean($('mintUri').value.trim());
        if (hasValue && step < 3 && !metaCid) step = 3;
        if (!hasValue && !metaCid && step > 2 && step < 4) step = 2;
        updateStepUI();
      });

      dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-black', 'bg-black/5'); });
      dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-black', 'bg-black/5'));
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-black', 'bg-black/5');
        const f = e.dataTransfer.files?.[0];
        if (f) setImageFile(f);
      });

      $('imageInput').addEventListener('change', (e) => {
        const f = e.target.files?.[0];
        if (f) setImageFile(f);
      });
      $('replaceBtn').addEventListener('click', () => {
        resetMetadataUI();
        saveFormData();
      });

      function setImageFile(file) {
        imageFile = file;
        $('imageEmpty').classList.add('hidden');
        $('imagePreviewWrap').classList.remove('hidden');
        $('imagePreview').src = URL.createObjectURL(file);
        $('imageInfo').textContent = `${file.name} ‚Ä¢ ${(file.size / 1024 / 1024).toFixed(2)} MB`;
        $('imageError').classList.add('hidden');
      }

      $('toMetaBtn').addEventListener('click', () => {
        if (!imageFile) {
          $('imageError').textContent = '–î–æ–±–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
          $('imageError').classList.remove('hidden');
          return;
        }
        step = 2;
        updateStepUI();
      });

      async function uploadImageToPinata(file) {
        const jwt = $('pinataJwt').value.trim();
        if (!jwt) throw new Error('–í–≤–µ–¥–∏—Ç–µ Pinata JWT');
        const form = new FormData();
        form.append('file', file);
        form.append('pinataMetadata', JSON.stringify({ name: file.name || 'nft-image', keyvalues: { app: 'DefNFT' } }));
        form.append('pinataOptions', JSON.stringify({ cidVersion: 1 }));
        const r = await fetch('https://api.pinata.cloud/pinning/pinFileToIPFS', {
          method: 'POST',
          headers: { Authorization: `Bearer ${jwt}` },
          body: form,
        });
        if (!r.ok) {
          const text = await r.text().catch(() => '');
          throw new Error(`pinFileToIPFS: ${r.status} ${text}`);
        }
        const j = await r.json();
        return j.IpfsHash;
      }

      async function uploadJsonToPinata(json) {
        const jwt = $('pinataJwt').value.trim();
        if (!jwt) throw new Error('–í–≤–µ–¥–∏—Ç–µ Pinata JWT');
        const r = await fetch('https://api.pinata.cloud/pinning/pinJSONToIPFS', {
          method: 'POST',
          headers: { Authorization: `Bearer ${jwt}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({
            pinataContent: json,
            pinataMetadata: { name: json.name || 'metadata' },
            pinataOptions: { cidVersion: 1 },
          }),
        });
        if (!r.ok) {
          const text = await r.text().catch(() => '');
          throw new Error(`pinJSONToIPFS: ${r.status} ${text}`);
        }
        const j = await r.json();
        return j.IpfsHash;
      }

      $('uploadBtn').addEventListener('click', async () => {
        try {
          const baseName = $('name').value.trim();
          const desc = $('description').value.trim();
          const partnerName = $('partnerName').value.trim();
          const grade = $('grade').value.trim() || 'Bronze';
          const pct = Number($('rewardPercent').value);

          $('nameErr').classList.add('hidden');
          $('descErr').classList.add('hidden');
          $('partnerErr').classList.add('hidden');
          $('pctErr').classList.add('hidden');

          if (!baseName) { $('nameErr').textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'; $('nameErr').classList.remove('hidden'); return; }
          if (!desc) { $('descErr').textContent = '–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ'; $('descErr').classList.remove('hidden'); return; }
          if (!partnerName) { $('partnerErr').textContent = '–í–≤–µ–¥–∏—Ç–µ partner name'; $('partnerErr').classList.remove('hidden'); return; }
          if (!Number.isFinite(pct) || pct < 0 || pct > 100) { $('pctErr').textContent = '–î–∏–∞–ø–∞–∑–æ–Ω 0‚Äì100'; $('pctErr').classList.remove('hidden'); return; }
          if (!imageFile) { $('imageError').textContent = '–î–æ–±–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'; $('imageError').classList.remove('hidden'); return; }

          showStatus('–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –≤ Pinata‚Ä¶');
          imageCid = await uploadImageToPinata(imageFile);
          $('imageCidBox').classList.remove('hidden');
          $('imageCid').textContent = 'ipfs://' + imageCid;
          $('imageGateway').href = 'https://ipfs.io/ipfs/' + imageCid;
          $('resImage').textContent = imageCid;
          saveFormData();

          const useHttp = $('httpImage').checked;
          const imageField = useHttp ? ('https://ipfs.io/ipfs/' + imageCid) : ('ipfs://' + imageCid);

          showStatus('–ü—É–±–ª–∏–∫—É–µ–º JSON-–º–µ—Ç–∞–¥–∞—Ç—É‚Ä¶');
          const json = {
            name: `${baseName} - ${pct}%`,
            description: desc,
            image: imageField,
            attributes: [
              { trait_type: 'Name', value: partnerName },
              { trait_type: 'Reward, %', value: Number(pct) },
              { trait_type: 'Grade', value: grade },
              { trait_type: 'Soulbound', value: 'true' },
            ],
          };
          metaCid = await uploadJsonToPinata(json);
          $('metaCidBox').classList.remove('hidden');
          $('metaCid').textContent = 'ipfs://' + metaCid;
          $('metaGateway').href = 'https://ipfs.io/ipfs/' + metaCid;
          $('resMeta').textContent = metaCid;
          $('mintUri').value = 'ipfs://' + metaCid;
          saveFormData();

          step = 3;
          updateStepUI();
          saveFormData();
          showStatus('–ì–æ—Ç–æ–≤–æ. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –º–∏–Ω—Ç–∏—Ç—å.');
        } catch (e) {
          console.error(e);
          showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (e?.message || e));
        }
      });

      $('mintBtn').addEventListener('click', async () => {
        const contractAddress = $('contractAddress').value.trim();
        const toAddress = $('mintTo').value.trim() || formatTonAddress(tonConnectUI.wallet?.account.address || '');
        const rewardPercent = $('mintReward').value;
        const uri = $('mintUri').value.trim();
        $('contractErr').classList.add('hidden');
        $('mintToErr').classList.add('hidden');
        try {
          if (!uri) throw new Error('–í–≤–µ–¥–∏—Ç–µ URI (–Ω–∞–ø—Ä–∏–º–µ—Ä, ipfs://...) –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –º–µ—Ç–∞–¥–∞—Ç—É');
          validateAddress(contractAddress, $('contractErr'));
          validateAddress(toAddress, $('mintToErr'));
          const shareBps = calcShareBps(rewardPercent);
          console.log('Mint to', toAddress, 'with shareBps', shareBps, 'with uri', uri);
          const { Address, beginCell } = window.TonCore;
          const body = buildOp(OPS.mint, (b) => {
            b.storeAddress(Address.parse(toAddress));
            b.storeInt(BigInt(shareBps), 257);
            const ref = beginCell();
            ref.storeStringTail(uri);
            b.storeRef(ref.endCell());
          });
          console.log('shareBps', BigInt(shareBps));
          console.log('Mint body', body.toBoc().toString('base64'));
          showStatus('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º mint‚Ä¶');
          await sendMessage(contractAddress, body, toNano('0.05'));
          showStatus('–ú–∏–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤ Tonkeeper.');
          step = 4;
          updateStepUI();
          let mintedIndex = null;
          let mintedAddress = '';
          try {
            mintedIndex = await getTokenIndex(contractAddress, toAddress);
          } catch (err) {
            console.warn('tokenOf lookup failed', err);
          }
          if (mintedIndex !== null && mintedIndex >= 0) {
            try {
              mintedAddress = await fetchNftAddressByIndex(contractAddress, mintedIndex);
            } catch (err) {
              console.warn('get_nft_address_by_index failed', err);
            }
          }
          $('resToken').textContent = mintedIndex !== null ? String(mintedIndex) : '‚Äî';
          resTokenAddressEl.textContent = mintedAddress || '‚Äî';
          if (mintedAddress) {
            nftAddressOut.textContent = mintedAddress;
          }
          if (mintedIndex !== null && mintedIndex >= 0) {
            nftIndexLookupEl.value = String(mintedIndex);
            saveFormData();
          }
          readCollectionData().catch(() => {});
          await readWalletState(toAddress).catch(() => {});
        } catch (e) {
          console.error(e);
          showStatus('–û—à–∏–±–∫–∞ –º–∏–Ω—Ç–∞: ' + (e?.message || e));
        }
      });

      $('burnBtn').addEventListener('click', async () => {
        const contractAddress = $('contractAddress').value.trim();
        try {
          validateAddress(contractAddress, $('contractErr'));
          const tokenId = validateTokenId($('burnTokenId').value);
          const body = buildOp(OPS.burn, (b) => b.storeInt(tokenId, 257));
          showStatus('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º burn‚Ä¶');
          await sendMessage(contractAddress, body, toNano('0.08'));
          showStatus('Burn –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.');
        } catch (e) {
          console.error(e);
          showStatus('–û—à–∏–±–∫–∞ burn: ' + (e?.message || e));
        }
      });

      $('addWhitelistBtn').addEventListener('click', () => toggleWhitelist(true));
      $('removeWhitelistBtn').addEventListener('click', () => toggleWhitelist(false));

      async function toggleWhitelist(add) {
        const contractAddress = $('contractAddress').value.trim();
        const target = $('whitelistAddr').value.trim();
        try {
          validateAddress(contractAddress, $('contractErr'));
          validateAddress(target, $('contractErr'));
          const op = add ? OPS.addWhitelist : OPS.removeWhitelist;
          const { Address } = window.TonCore;
          const body = buildOp(op, (b) => b.storeAddress(Address.parse(target)));
          showStatus(`${add ? '–î–æ–±–∞–≤–ª—è–µ–º' : '–£–¥–∞–ª—è–µ–º'} whitelist‚Ä¶`);
          await sendMessage(contractAddress, body, toNano('0.05'));
          showStatus('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.');
        } catch (e) {
          console.error(e);
          showStatus('Whitelist error: ' + (e?.message || e));
        }
      }

      $('setProcessorBtn').addEventListener('click', async () => {
        const contractAddress = $('contractAddress').value.trim();
        const target = $('processorAddr').value.trim();
        const allowed = $('processorAllowed').checked;
        try {
          validateAddress(contractAddress, $('contractErr'));
          validateAddress(target, $('contractErr'));
          const { Address } = window.TonCore;
          const body = buildOp(OPS.setProcessor, (b) => {
            b.storeAddress(Address.parse(target));
            b.storeBit(allowed);
          });
          showStatus('–û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä‚Ä¶');
          await sendMessage(contractAddress, body, toNano('0.05'));
          showStatus('SetTxProcessor –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.');
        } catch (e) {
          console.error(e);
          showStatus('SetTxProcessor error: ' + (e?.message || e));
        }
      });

      $('incrementBtn').addEventListener('click', async () => {
        const contractAddress = $('contractAddress').value.trim();
        const wallet = $('incrementWallet').value.trim();
        try {
          validateAddress(contractAddress, $('contractErr'));
          validateAddress(wallet, $('contractErr'));
          const { Address } = window.TonCore;
          const body = buildOp(OPS.increment, (b) => b.storeAddress(Address.parse(wallet)));
          showStatus('IncrementSuccessfulTx‚Ä¶');
          await sendMessage(contractAddress, body, toNano('0.05'));
          showStatus('IncrementSuccessfulTx –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.');
        } catch (e) {
          console.error(e);
          showStatus('Increment error: ' + (e?.message || e));
        }
      });

      async function readWalletState(overrideAddr) {
        const contractAddress = $('contractAddress').value.trim();
        const wallet = overrideAddr || $('walletLookup').value.trim();
        if (!contractAddress || !wallet) return;
        try {
          const client = await rpcClientForCurrentNet();
          const { TonAddress } = window.TonRpc;
          const cAddr = TonAddress.parse(contractAddress);
          const tokenOf = await client.runMethod(cAddr, 'tokenOf', [stackAddress(wallet)]);
          const share = await client.runMethod(cAddr, 'platformShareBpsForWallet', [stackAddress(wallet)]);
          const whitelist = await client.runMethod(cAddr, 'isWalletWhitelisted', [stackAddress(wallet)]);
          const success = await client.runMethod(cAddr, 'successfulTxCountOf', [stackAddress(wallet)]);
          $('tokenOfOut').textContent = tokenOf.stack.readNumber().toString();
          $('shareOut').textContent = share.stack.readNumber().toString();
          $('whitelistOut').textContent = whitelist.stack.readNumber() === 1 ? 'true' : 'false';
          $('successOut').textContent = success.stack.readNumber().toString();
        } catch (e) {
          console.error(e);
          showStatus('Read wallet error: ' + (e?.message || e));
        }
      }

      $('readWalletBtn').addEventListener('click', () => readWalletState());

      $('ownerOfBtn').addEventListener('click', async () => {
        const contractAddress = $('contractAddress').value.trim();
        const tokenId = $('ownerOfTokenId').value.trim();
        try {
          if (!contractAddress) throw new Error('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞');
          const id = validateTokenId(tokenId);
          const client = await rpcClientForCurrentNet();
          const { TonAddress } = window.TonRpc;
          const { beginCell } = window.TonCore;
          const cell = beginCell();
          cell.storeInt(id, 257);
          const res = await client.runMethod(TonAddress.parse(contractAddress), 'ownerOf', [
            { type: 'slice', cell: cell.endCell() },
          ]);
          const addr = res.stack.readAddress();
          $('ownerOfOut').textContent = addr.toString({ bounceable: false });
        } catch (e) {
          console.error(e);
          $('ownerOfOut').textContent = '–û—à–∏–±–∫–∞: ' + (e?.message || e);
        }
      });

      $('readWalletBtn').addEventListener('click', () => {
        const addr = $('walletLookup').value.trim();
        if (addr) $('resToken').textContent = `wallet ${addr.slice(0, 6)}‚Ä¶`;
      });

      $('resetBtn').addEventListener('click', () => {
        clearFormData();
        $('pinataJwt').value = '';
        $('name').value = 'Partner NFT';
        $('description').value = 'Soulbound partner NFT with revenue share.';
        $('partnerName').value = '';
        $('rewardPercent').value = '10';
        $('grade').value = 'Bronze';
        $('httpImage').checked = false;
        $('contractAddress').value = '';
        $('mintTo').value = '';
        $('mintReward').value = '10';
        $('walletLookup').value = '';
        $('burnTokenId').value = '';
        $('whitelistAddr').value = '';
        $('processorAddr').value = '';
        $('processorAllowed').checked = false;
        $('incrementWallet').value = '';
        $('ownerOfTokenId').value = '';
        $('tonNetwork').value = 'testnet';
        $('netInfo').textContent = '–°–µ—Ç—å: TON Testnet';
        $('status').textContent = '';
        $('tokenOfOut').textContent = '‚Äî';
        $('shareOut').textContent = '‚Äî';
        $('whitelistOut').textContent = '‚Äî';
        $('successOut').textContent = '‚Äî';
        $('ownerOfOut').textContent = '‚Äî';
        collectionDataOut.textContent = '‚Äî';
        nftAddressOut.textContent = '‚Äî';
        nftDataOut.textContent = '‚Äî';
        resTokenAddressEl.textContent = '‚Äî';
        resetMetadataUI();
        saveFormData();
      });

      $('results').classList.add('hidden');
      const observer = new MutationObserver(() => {
        if (imageCid || metaCid) $('results').classList.remove('hidden');
        else $('results').classList.add('hidden');
      });
      observer.observe($('resImage'), { childList: true });
      observer.observe($('resMeta'), { childList: true });
    });
  </script>
</body>

</html>
